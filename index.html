<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Mietpreise In Karlsruhe</title>
        <meta name="viewport" content="initial-scale=1,width=device-width">

        <link rel="stylesheet" href="Leaflet-0.7.3/leaflet.css"/>
        <link rel="stylesheet" href="Leaflet.label/leaflet.label.css"/>
        <link rel="stylesheet" href="style.css"/>

        <script src="jquery-1.11.2.min.js"></script>

        <script>
            // Force canvas display, much faster when displaying a lot of
            // circle markers. See
            // http://leafletjs.com/reference.html#path-canvas
            var L_PREFER_CANVAS = true;
        </script>
        <script src="Leaflet-0.7.3/leaflet.js"></script>
        <script src="Leaflet.label/leaflet.label.js"></script>

        <script src="colormap.js"></script>

        <script>
            var TILES_URL = 'http://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png';
            var INITIAL_LOCATION = [49.0140679, 8.4044366];
            var INITIAL_ZOOM = 13;
            var ATTRIBUTION = 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> ' +
                              'contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">' +
                              'CC-BY-SA</a>. Tiles &copy; <a href="http://cartodb.com/attributions">' +
                              'CartoDB</a>';

            var OVERLAY_URL = 'http://karlsruhe.codefor.de/mieten/heatmap.png';
            var OVERLAY_BOUNDS = [[48.92, 8.28], [49.08, 8.53]];
            var OVERLAY_OPTIONS = {opacity: 0.75};

            var CIRCLE_RADIUS = 3;
            var CIRCLE_OPTIONS = {stroke: false, fillOpacity: 1};

            var RENT_URL = "//karlsruhe.codefor.de/mieten/mieten.json";
            var MIN_RENT = 5;
            var MAX_RENT = 20;
            var RENT_SPAN = MAX_RENT - MIN_RENT;

            var map;


            /*
               Compute the arithmetic mean of a list of values.
            */
            function mean(values) {
                var sum = 0;
                for (var index in values) {
                    sum += values[index];
                }
                return sum / values.length;
            }


            /*
               Merge data points who have the same coordinates.

               The corresponding rent is the average of the merged rents.
            */
            function mergeDataPoints(points) {
                var merged = {};
                for (var index in points) {
                    var point = points[index];
                    var key = [point[0], point[1]];
                    if (key in merged) {
                        merged[key][1].push(point[2]);
                    } else {
                        merged[key] = [[point[0], point[1]], [point[2]]];
                    }
                }
                var result = [];
                for (var key in merged) {
                    if (merged.hasOwnProperty(key)) {
                        var entry = merged[key];
                        result.push([entry[0][0], entry[0][1], mean(entry[1])]);
                    }
                }
                return result;
            }

            function addMarkers(json) {
                json = mergeDataPoints(json);
                for (var index in json) {
                    var point = json[index];
                    if (point[2] < MIN_RENT || point[2] > MAX_RENT) {
                        continue;
                    }
                    var fillColor = colormap((point[2] - MIN_RENT) / RENT_SPAN);
                    var options = $.extend({'fillColor': fillColor}, CIRCLE_OPTIONS);
                    var label = (point[2].toFixed(2) + ' €/m²').replace(/\./, ',');
                    L.circleMarker([point[0], point[1]], options)
                        .setRadius(CIRCLE_RADIUS)
                        .bindLabel(label)
                        .addTo(map);
                }
            }

            function drawOverlay() {
                L.imageOverlay(OVERLAY_URL, OVERLAY_BOUNDS, OVERLAY_OPTIONS)
                    .addTo(map);
            }

            function initColorbar() {
                var gradient = colormap_gradient('to right');
                $('#colorbar').css('background', gradient);
                $('#min-rent').html(MIN_RENT + ' €/m²');
                $('#max-rent').html(MAX_RENT + ' €/m²');
            }

            function initLegend() {
                var legend = L.control({position: 'bottomright'});
                legend.onAdd = function (m) {
                    return L.DomUtil.get('legend');
                };
                legend.addTo(map);
                initColorbar();
            }

            function initMap() {
                var tiles = new L.TileLayer(TILES_URL, {attribution: ATTRIBUTION});
                map = new L.Map('map')
                    .addLayer(tiles)
                    .setView(INITIAL_LOCATION, INITIAL_ZOOM);
                initLegend();
                drawOverlay();
                $.getJSON(RENT_URL, addMarkers);
            }

            $(document).ready(initMap);
        </script>
    </head>
    <body>
        <div id="map"></div>
        <div id="legend">
            <h1>Mietpreise in Karlsruhe</h1>
            <div id="scale">
                <div id="colorbar"></div>
                <span id="min-rent"></span><span id="max-rent"></span>
            </div>
            <p>Ein Projekt des <a href="http://codefor.de/karlsruhe">Open Knowledge Lab Karlsruhe</a>, basierend auf den Kaltmieten aus Anzeigen von <a href="https://www.immobilienscout24.de">ImmobilienScout24</a>.</p>
            <p>Rohdaten: <a href="http://karlsruhe.codefor.de/mieten/mieten.json">JSON</a>.</p>
            <p>Quellcode: <a href="https://github.com/CodeforKarlsruhe/mietmap-scraper">Scraper</a>, <a href="https://github.com/CodeforKarlsruhe/mietmap-overlay">Heatmap</a>, <a href="https://github.com/CodeforKarlsruhe/mietmap">Karte</a>.</p>
        </div>
    </body>
</html>

